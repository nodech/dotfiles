#!/usr/bin/env bash

title="$1"
description="${2:-}"

if [[ -z "$title" ]]; then
    echo "Usage: notify <title> [description] [color]" >&2
    echo "Colors: success/green, warning/yellow, error/red, info/blue (default)" >&2
    exit 1
fi

case "${3:-info}" in
    success|green)  color=65280 ;;
    warning|yellow) color=16776960 ;;
    error|red)      color=15158332 ;;
    info|blue|*)    color=3447003 ;;
esac

DISCORD_WEBHOOK_URL=$(pass show discord/webhookurl)

if [[ -z "$DISCORD_WEBHOOK_URL" ]]; then
    echo "Error: DISCORD_WEBHOOK_URL not set" >&2
    exit 1
fi

payload=$(jq -n \
    --arg content "@everyone" \
    --arg title "$title" \
    --arg desc "$description" \
    --argjson color "$color" \
    '{content: $content, embeds: [{title: $title, description: $desc, color: $color}]}'
)

curl -s -H "Content-Type: application/json" -d "$payload" "$DISCORD_WEBHOOK_URL"
